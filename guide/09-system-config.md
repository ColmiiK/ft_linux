<!-- markdownlint-configure-file { "MD013": { "line_length": 300 } } -->

# System configuration

Booting a Linux system involves several tasks, like mounting file systems, initializing packages,
setting the system clock, networking, etc.
This must be organized to ensure the tasks are performed in the correct order and quickly as possible.

## System V

This is the classic boot process used in Unix-like systems since 1983.
It consists of a small `init` program that sets up basic processes and runs a script.

The `init` program is controlled by `/etc/inittab`, organized in run levels.
In LFS, they are used as follows.

- 0: halt
- 1: Single user mode
- 2: User definable
- 3: Full multiuser mode
- 4: User definable
- 5: Full multiuser mode with display manager
- 6: reboot

The usual default run level is 3 or 5.

This system is easy to understand and customizable, but may be slow, around 8-12 seconds.

## LFS-Bootscripts

- < 0.1 SBU
- 244 KB

Install the package.

```shell
make install
```

## Overview of device and module handling

This subchapter goes into depth about udev, its history, how it works and some more details.
I recommend you read it directly.

- [Overview of device and module handling](https://www.linuxfromscratch.org/lfs/view/stable/chapter09/udev.html)

## Managing devices

### Network devices

Udev names network devices based on firmware or physical characteristics, such as bus, slot or MAC address.
This is to ensure the naming is consistent.
Before, devices used to be named in a persistent way: eth0, eht1, etc. But this meant that sometimes a
card might be read before than other, swapping the names around in a specific boot.

However, this can be beneficial, as long as we only have one type of device, that is, one ethernet device for example.

Let's generate the default rules first.

```shell
bash /usr/lib/udev/init-net-rules.sh
```

Inspect them.

```shell
cat /etc/udev/rules.d/70-persistent-net.rules

# This file was automatically generated by the /lib/udev/write_net_rules
# program, run by the persistent-net-generator.rules rules file.
#
# You can modify it, as long as you keep each rule on a single
# line, and change only the value of the NAME= key.

# net device e1000
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="08:00:27:02:ca:0f", ATTR{dev_id}=="0x0", ATTR{type}=="1", NAME="enp0s3"
```

Again, you can see an in depth description of the rules in the LFS.

### CD-ROM symlinks

Udev provides a script to generate the symlinks, either by id or by path. To know what that means,
I defer you again to the LFS.

### Dealing with duplicate devices

Since the naming of devices is basically random each reboot, we need to fix this by
creating udev rules that symlink the devices to their names.

To fix this, figure out the attributes that uniquely identify your device.
For example.

```shell
udevadm info -a -p /sys/class/video4linux/video0
```

It can be a serial number, product ID, etc.
Then, write the rules for the symlinks. For example.

```shell
cat > /etc/udev/rules.d/83-duplicate_devs.rules << "EOF"

# Persistent symlinks for webcam and tuner
KERNEL=="video*", ATTRS{idProduct}=="1910", ATTRS{idVendor}=="0d81", SYMLINK+="webcam"
KERNEL=="video*", ATTRS{device}=="0x036f",  ATTRS{vendor}=="0x109e", SYMLINK+="tvtuner"

EOF
```

## General network configuration

The files in `/etc/sysconfig` determine which interfaces are brought up and down by the
network script. Each should contain a file named something like `ifconfig.xyz` where
"xyz" is the name of the network card.

The following command creates a sample file for the device with a static IP address.

```shell
cd /etc/sysconfig/
cat > ifconfig.enp0s3 << "EOF"
ONBOOT=yes
IFACE=enp0s3
SERVICE=ipv4-static
IP=192.168.1.2
GATEWAY=192.168.1.1
PREFIX=24
BROADCAST=192.168.1.255
EOF
```

The system will need some means of obtaining DNS name resolution.
We can achieve this by creating a `/etc/resolv.conf` file with that information.

```shell
cat > /etc/resolv.conf << "EOF"
# Begin /etc/resolv.conf

# domain <Your Domain Name>
nameserver 8.8.8.8
nameserver 8.8.4.4

# End /etc/resolv.conf
EOF
```

Create a `/etc/hostname` file.

```shell
echo "lfs" > /etc/hostname
```

And a `/etc/hosts` file.

```shell
cat > /etc/hosts << "EOF"
# Begin /etc/hosts

127.0.0.1 localhost.localdomain localhost
127.0.1.1 lfs. lfs
# <192.168.1.2> <FQDN> <HOSTNAME> [alias1] [alias2 ...]
::1       localhost ip6-localhost ip6-loopback
ff02::1   ip6-allnodes
ff02::2   ip6-allrouters

# End /etc/hosts
EOF
```

For information about the configuration of these files, read the LFS.

## System V bootscript usage and configuration

Now, to configure SysVinit.

During kernel initialization, the first program to run if not overwritten is init.
It needs a config file, so create it.

```shell
cat > /etc/inittab << "EOF"
# Begin /etc/inittab

id:3:initdefault:

si::sysinit:/etc/rc.d/init.d/rc S

l0:0:wait:/etc/rc.d/init.d/rc 0
l1:S1:wait:/etc/rc.d/init.d/rc 1
l2:2:wait:/etc/rc.d/init.d/rc 2
l3:3:wait:/etc/rc.d/init.d/rc 3
l4:4:wait:/etc/rc.d/init.d/rc 4
l5:5:wait:/etc/rc.d/init.d/rc 5
l6:6:wait:/etc/rc.d/init.d/rc 6

ca:12345:ctrlaltdel:/sbin/shutdown -t1 -a -r now

su:S06:once:/sbin/sulogin
s1:1:respawn:/sbin/sulogin

1:2345:respawn:/sbin/agetty --noclear tty1 9600
2:2345:respawn:/sbin/agetty tty2 9600
3:2345:respawn:/sbin/agetty tty3 9600
4:2345:respawn:/sbin/agetty tty4 9600
5:2345:respawn:/sbin/agetty tty5 9600
6:2345:respawn:/sbin/agetty tty6 9600

# End /etc/inittab
EOF
```

To customize and learn more about init, read on the LFS.

To configure the system clock, create a new config file.
Change the value of UTC to 0 if the hardware clock is not set to UTC.

```shell
cat > /etc/sysconfig/clock << "EOF"
# Begin /etc/sysconfig/clock

UTC=1

# Set this to any options you might need to give to hwclock,
# such as machine hardware clock type for Alphas.
CLOCKPARAMS=

# End /etc/sysconfig/clock
EOF
```

Now, let's configure the linux console itself.
If you want to customize your locale, check the LFS for more info.
I'm going to leave it as default.

Set a system font.

```shell
cat > /etc/sysconfig/console << "EOF"
# Begin /etc/sysconfig/console

UNICODE="1"
FONT="Lat2-Terminus16"

# End /etc/sysconfig/console
EOF
```

You can customize all of these options directly in the `/etc/sysconfig/rc.site` file,
or individually in each script.

## Configuring system locale

First, obtain a list of all available locales by running this command.

```shell
locale -a
```

Choose your locale and then, input this command, where locale name is the full name of your locale.
For example, `es_ES.iso885915@euro`.

```shell
LC_ALL=<locale name> locale charmap
```

This will return a canonical name for your locale, for example: `ISO-8859-15`.

Meaning that the final locale setting for me would be:

- `es_ES.ISO-8859-15`

Not confusing at all.

Now run these commands to ensure that the locale is installed.
None of these commands should fail.

```shell
LC_ALL=<locale name> locale language
LC_ALL=<locale name> locale charmap
LC_ALL=<locale name> locale int_curr_symbol
LC_ALL=<locale name> locale int_prefix
```

To configure bash, create the following `/etc/profile` file.
Replace the `LANG=<ll>_<CC>.<charmap><@modifiers>` accordingly.

```shell
cat > /etc/profile << "EOF"
# Begin /etc/profile

for i in $(locale); do
  unset ${i%=*}
done

if [[ "$TERM" = linux ]]; then
  export LANG=C.UTF-8
else
  export LANG=<ll>_<CC>.<charmap><@modifiers>
fi

# End /etc/profile
EOF
```

## Create the /etc/inputrc file

This is the configuration file for readline.
This command will create a generic configuration for all users.

```shell
cat > /etc/inputrc << "EOF"
# Begin /etc/inputrc
# Modified by Chris Lynn <roryo@roryo.dynup.net>

# Allow the command prompt to wrap to the next line
set horizontal-scroll-mode Off

# Enable 8-bit input
set meta-flag On
set input-meta On

# Turns off 8th bit stripping
set convert-meta Off

# Keep the 8th bit for display
set output-meta On

# none, visible or audible
set bell-style none

# All of the following map the escape sequence of the value
# contained in the 1st argument to the readline specific functions
"\eOd": backward-word
"\eOc": forward-word

# for linux console
"\e[1~": beginning-of-line
"\e[4~": end-of-line
"\e[5~": beginning-of-history
"\e[6~": end-of-history
"\e[3~": delete-char
"\e[2~": quoted-insert

# for xterm
"\eOH": beginning-of-line
"\eOF": end-of-line

# for Konsole
"\e[H": beginning-of-line
"\e[F": end-of-line

# End /etc/inputrc
EOF
```

## Create the /etc/shells file

This file contains a list of login shells on the system.

```shell
cat > /etc/shells << "EOF"
# Begin /etc/shells

/bin/sh
/bin/bash

# End /etc/shells
EOF
```
